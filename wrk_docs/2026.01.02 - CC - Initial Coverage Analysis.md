# Code Coverage Report - 2026.01.02

## Overview
**Project:** mdmp3tomp4
**Date:** 2026-01-02
**Current Status:** High coverage on core logic and CLI parsing. Gaps exist in error handling, specific fallback paths, and batch processing orchestration.

## Coverage Breakdown

### 1. CLI Parsing (`parse_args`, `parse_args_from`, Enums)
*   **Status:** High (95%)
*   **Covered:**
    *   `parse_args_from`: Valid inputs, glob expansion, flags, batch warnings.
    *   `VisualizationType`, `SpectrumColorScheme`: All variants tested.
    *   `VisualizationPosition`: Standard and custom `xy` parsing tested.
*   **Missing:**
    *   `print_usage()`: Not currently invoked or verified in tests.
    *   `parse_args()`: The thin wrapper around `env::args()` is not tested (standard practice to exclude or minimal test).

### 2. Configuration & Helpers
*   **Status:** High (100%)
*   **Covered:**
    *   `derive_output_path`: Windows/Unix paths, custom output directories.
    *   `get_spectrum_params`: Orientation logic.
    *   `get_position_overlay`: Filter string generation.
    *   `ext_from_mime`: Mime type mapping.

### 3. Core Logic (`create_video`, `get_filter_complex`)
*   **Status:** Medium-High (85%)
*   **Covered:**
    *   `create_video`: Happy path for Waveform, Spectrum, and Both.
    *   `get_filter_complex`: Verified indirectly via successful ffmpeg execution in integration tests.
*   **Missing:**
    *   **Error Handling:** `create_video` failures (e.g., audio file missing, ffmpeg crashing, zero-byte output) are not tested.
    *   **Thumbnails:** `write_thumbnail` is run in happy path, but transcoding logic (png->jpg) or failure modes are not explicitly isolated.

### 4. Cover Art Extraction (`extract_cover_*`)
*   **Status:** Medium (60%)
*   **Covered:**
    *   `extract_cover_via_id3`: Tested via `test_cover_extraction_workflow`.
    *   `extract_cover_to_file`: Happy path (ID3 priority).
*   **Missing:**
    *   `extract_cover_via_ffmpeg`: This fallback path is **not** reached because the test file uses ID3. We need a test case with a file lacking ID3 tags but having an attached picture stream, or a scenario where ID3 extraction fails.

### 5. Application Orchestration (`run_batch`, `main`)
*   **Status:** Low (20%)
*   **Covered:**
    *   Individual components are tested.
*   **Missing:**
    *   `run_batch`: The loop itself is not verified to process multiple files in sequence.
    *   `main`: Entry point not tested (acceptable to exclude if logic is delegated).

## Summary
The project is well-tested for "Happy Paths" and input parsing. To reach 98% coverage, we must target:
1.  **Error Paths:** Simulate ffmpeg failures.
2.  **Fallback Logic:** Force execution of `extract_cover_via_ffmpeg`.
3.  **Batch Processing:** Verify `run_batch` actually iterates.
4.  **CLI Output:** Verify `print_usage` matches expectations.

## Recommendations
Implement a multistage plan targeting these specific missing branches. Focus on integration tests that mock or construct specific file states to trigger edge cases.
