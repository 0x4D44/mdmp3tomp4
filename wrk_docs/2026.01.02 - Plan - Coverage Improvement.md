# Multistage Coverage Improvement Plan

**Goal:** Increase code coverage from ~80% to >98%.

## Stage 1: Batch Processing & Usage
**Objective:** Verify the application loop and help output.
1.  **Test `print_usage`:** Capture stdout and verify usage text.
2.  **Test `run_batch`:** Create multiple dummy files and ensure `run_batch` processes all of them (mocking the actual video creation or using a lightweight config).
    *   *Note:* Since `create_video` is heavy, we might need to verify `run_batch` logic by checking if output files exist.

## Stage 2: Cover Art Fallback & Edge Cases
**Objective:** Cover the `extract_cover_via_ffmpeg` path and `write_thumbnail` variations.
1.  **FFmpeg Cover Extraction:** Create a test file *without* ID3 tags but *with* a video stream (using ffmpeg to mux an image as a stream).
2.  **Thumbnail Transcoding:** Test `write_thumbnail` with a PNG source requesting a JPG output (forcing ffmpeg usage).

## Stage 3: Error Handling
**Objective:** Verify resilience against missing files and external tool failures.
1.  **Missing Audio:** Call `create_video` with a non-existent path.
2.  **FFmpeg Failure:** Call `create_video` with a corrupted audio file or invalid arguments that cause ffmpeg to exit with non-zero status.
3.  **Zero-Byte Output:** Simulate a scenario where ffmpeg runs but produces empty output (if possible).

## Stage 4: Refinement
**Objective:** Clean up and cover any remaining lines.
1.  **Unused Enums:** Ensure all enum variants are at least instantiated/parsed (already mostly done).
2.  **Main Entry:** Optional. Add a smoke test for `main` if feasible.

## Execution Order
1.  Implement Stage 1 (Batch/Usage).
2.  Implement Stage 2 (Cover Fallback).
3.  Implement Stage 3 (Errors).
4.  Final Verification.
